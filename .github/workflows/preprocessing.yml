name: Wine Quality Preprocessing Pipeline

on:
  push:
    branches: [main, develop]
    paths:
      - "preprocessing/**"
      - ".github/workflows/preprocessing.yml"
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      dataset_url:
        description: "Dataset URL"
        required: false
        default: "https://archive.ics.uci.edu/ml/machine-learning-databases/wine-quality/winequality-red.csv"

jobs:
  preprocessing:
    name: Data Preprocessing
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ”„ Checkout Repository
        uses: actions/checkout@v3

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: "pip"

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ðŸ“Š Run Preprocessing Pipeline
        working-directory: ./preprocessing
        run: |
          echo "ðŸš€ Starting preprocessing pipeline..."
          python automation_Saepulloh.py
          echo "âœ… Preprocessing completed!"

      - name: ðŸ” Verify Output Files
        working-directory: ./preprocessing/data/output
        run: |
          echo "ðŸ“‹ Checking generated files..."
          ls -lh

          files=("X_train_scaled.npy" "X_test_scaled.npy" "y_train.npy" "y_test.npy" "scaler.pkl" "feature_names.pkl")
          for file in "${files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file not found"
              exit 1
            fi
          done

      - name: ðŸ“ˆ Generate Dataset Statistics
        working-directory: ./preprocessing
        run: |
          python -c "
          import numpy as np
          import pickle

          print('\nðŸ“Š Dataset Statistics:')
          print('=' * 50)

          X_train = np.load('data/output/X_train_scaled.npy')
          X_test = np.load('data/output/X_test_scaled.npy')
          y_train = np.load('data/output/y_train.npy')
          y_test = np.load('data/output/y_test.npy')

          with open('data/output/feature_names.pkl', 'rb') as f:
            features = pickle.load(f)

          print(f'âœ… Training samples: {X_train.shape[0]}')
          print(f'âœ… Test samples: {X_test.shape[0]}')
          print(f'âœ… Features: {len(features)}')
          print(f'âœ… Train label distribution: {dict(zip(*np.unique(y_train, return_counts=True)))}')
          print(f'âœ… Test label distribution: {dict(zip(*np.unique(y_test, return_counts=True)))}')
          print('=' * 50)
          "

      - name: ðŸ“¤ Upload Preprocessed Data as Artifact
        uses: actions/upload-artifact@v3
        with:
          name: preprocessed-wine-data
          path: preprocessing/data/output/
          retention-days: 30

      - name: ðŸ“Š Create Summary Report
        run: |
          cat > $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸŽ‰ Preprocessing Pipeline Summary

          ### âœ… Status: SUCCESS

          **Generated Files:**
          - X_train_scaled.npy
          - X_test_scaled.npy
          - y_train.npy
          - y_test.npy
          - scaler.pkl
          - feature_names.pkl

          **Next Steps:**
          - Download artifacts for model training
          - Run \`modelling.py\` or \`modelling_tuning.py\`

          **Artifacts available in workflow run.**
          EOF

      - name: ðŸ’¬ Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… Preprocessing pipeline completed successfully! Artifacts are ready for model training.'
            })

  data-validation:
    name: Data Quality Checks
    runs-on: ubuntu-latest
    needs: preprocessing

    steps:
      - name: ðŸ”„ Checkout Repository
        uses: actions/checkout@v3

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: ðŸ“¥ Download Preprocessed Data
        uses: actions/download-artifact@v3
        with:
          name: preprocessed-wine-data
          path: ./artifacts/preprocessed/

      - name: ðŸ” Validate Data Quality
        run: |
          python -c "
          import numpy as np
          import sys

          print('ðŸ” Running Data Quality Checks...')
          print('=' * 50)

          X_train = np.load('artifacts/preprocessed/X_train_scaled.npy')
          X_test = np.load('artifacts/preprocessed/X_test_scaled.npy')
          y_train = np.load('artifacts/preprocessed/y_train.npy')
          y_test = np.load('artifacts/preprocessed/y_test.npy')

          errors = []

          if np.isnan(X_train).any() or np.isnan(X_test).any():
            errors.append('âŒ NaN values detected in features')
          else:
            print('âœ… No NaN values in features')

          train_mean = np.mean(X_train)
          train_std = np.std(X_train)
          if not (-0.1 < train_mean < 0.1 and 0.9 < train_std < 1.1):
            errors.append(f'âŒ Scaling issue: mean={train_mean:.4f}, std={train_std:.4f}')
          else:
            print(f'âœ… Proper scaling: mean={train_mean:.4f}, std={train_std:.4f}')

          unique_train = np.unique(y_train)
          unique_test = np.unique(y_test)
          if not (set(unique_train) == {0, 1} and set(unique_test) == {0, 1}):
            errors.append('âŒ Label values are not binary (0, 1)')
          else:
            print('âœ… Binary labels confirmed (0, 1)')

          total = len(y_train) + len(y_test)
          train_ratio = len(y_train) / total
          if not (0.7 <= train_ratio <= 0.9):
            errors.append(f'âŒ Unusual train/test split: {train_ratio:.2%}')
          else:
            print(f'âœ… Train/test split: {train_ratio:.2%}/{1-train_ratio:.2%}')

          train_pos_ratio = np.mean(y_train)
          test_pos_ratio = np.mean(y_test)
          if not (0.3 <= train_pos_ratio <= 0.7 and 0.3 <= test_pos_ratio <= 0.7):
            print(f'âš ï¸  Class imbalance: Train={train_pos_ratio:.2%}, Test={test_pos_ratio:.2%}')
          else:
            print(f'âœ… Balanced classes: Train={train_pos_ratio:.2%}, Test={test_pos_ratio:.2%}')

          print('=' * 50)

          if errors:
            print('\nâŒ Data Quality Issues:')
            for error in errors:
              print(f'  {error}')
            sys.exit(1)
          else:
            print('\nâœ… All data quality checks passed!')
          "
