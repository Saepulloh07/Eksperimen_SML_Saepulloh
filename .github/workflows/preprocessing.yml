name: Heart Disease Preprocessing Pipeline

# Trigger
on:
  push:
    branches: [main, master]
    paths:
      - "preprocessing/heart_disease_uci.csv"
      - "preprocessing/automate_Saepulloh.py"
      - "preprocessing/requirements.txt"
  pull_request:
    branches: [main, master]
    paths:
      - "preprocessing/heart_disease_uci.csv"
      - "preprocessing/automate_Saepulloh.py"
      - "preprocessing/requirements.txt"
  workflow_dispatch: # bisa dijalankan manual

jobs:
  preprocess:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./preprocessing

    steps:
      # 1. Checkout kode
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Setup Python
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # 3. Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. Jalankan preprocessing
      - name: Run Preprocessing Pipeline
        run: |
          python automate_Saepulloh.py

      # 5. Upload semua hasil sebagai artifact
      - name: Upload Preprocessing Results
        uses: actions/upload-artifact@v4
        with:
          name: heart-disease-preprocessing-output
          path: preprocessing/heart_disease_uci_pipeline/
          retention-days: 30

      # 6. (Opsional) Commit & push hasil kembali ke repo
      - name: Commit & Push hasil preprocessing
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add preprocessing/heart_disease_uci_pipeline/

          if git diff --staged --quiet; then
            echo "Tidak ada perubahan baru."
          else
            git commit -m "chore: update preprocessing results [skip ci]" || echo "Commit failed (mungkin tidak ada perubahan)"
            git push origin HEAD:${{ github.ref_name }} || echo "Push gagal (mungkin karena race condition, tidak masalah)"
          fi

      # 7. Ringkasan di tab Summary
      - name: Workflow Summary
        if: always()
        run: |
          echo "## Heart Disease Preprocessing Selesai!" >> $GITHUB_STEP_SUMMARY
          echo "Dataset: \`preprocessing/heart_disease_uci.csv\`" >> $GITHUB_STEP_SUMMARY
          echo "- Hasil tersimpan di: \`preprocessing/heart_disease_uci_pipeline/\`" >> $GITHUB_STEP_SUMMARY
          echo "- Artifact: [Download semua hasil](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
