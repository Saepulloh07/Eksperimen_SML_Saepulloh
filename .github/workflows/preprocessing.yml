name: Wine Quality Preprocessing Pipeline

on:
  push:
    branches: [main, develop]
    paths:
      - "preprosessing/**"
      - ".github/workflows/preprocessing-pipeline.yml"
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  preprocess-and-validate:
    name: Preprocessing + Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: pip

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy scikit-learn joblib python-dotenv

      - name: Run Preprocessing Script
        working-directory: ./preprosessing
        run: |
          echo "Starting preprocessing..."
          python automate_Saepulloh.py
          echo "Preprocessing completed successfully."

      - name: Validate Output Files Exist
        working-directory: ./preprosessing/data/output
        run: |
          echo "Checking output files..."
          for f in X_train_scaled.npy X_test_scaled.npy y_train.npy y_test.npy scaler.pkl feature_names.pkl; do
            [ -f "$f" ] && echo "OK $f" || (echo "MISSING $f" && exit 1)
          done

      - name: Data Quality Validation
        working-directory: ./preprosessing
        run: |
          python - <<'PY'
          import numpy as np
          import pickle
          import sys

          print("\nDATA QUALITY VALIDATION")
          print("="*50)

          X_train = np.load('data/output/X_train_scaled.npy')
          X_test  = np.load('data/output/X_test_scaled.npy')
          y_train = np.load('data/output/y_train.npy')
          y_test  = np.load('data/output/y_test.npy')

          with open('data/output/feature_names.pkl', 'rb') as f:
              features = pickle.load(f)

          errors = []

          if np.isnan(X_train).any() or np.isnan(X_test).any():
              errors.append("NaN values detected")

          mean = X_train.mean()
          std  = X_train.std()
          if not (-0.15 < mean < 0.15 and 0.85 < std < 1.15):
              errors.append(f"Scaling issue → mean={mean:.5f}, std={std:.5f}")

          if set(np.unique(y_train)) != {0, 1}:
              errors.append("Train labels not binary (0/1)")

          if set(np.unique(y_test)) != {0, 1}:
              errors.append("Test labels not binary (0/1)")

          ratio = len(y_train) / (len(y_train) + len(y_test))
          if not (0.65 <= ratio <= 0.90):
              errors.append(f"Train/test split unusual: {ratio:.1%}")

          print(f"Shape     → Train: {X_train.shape}, Test: {X_test.shape}")
          print(f"Features  → {len(features)}")
          print(f"Split     → {ratio:.1%} train")
          print(f"Mean/Std  → {mean:.5f} / {std:.5f}")

          if errors:
              print("\nFAILED VALIDATION:")
              for e in errors:
                  print("  ❌", e)
              sys.exit(1)
          else:
              print("\nALL VALIDATION PASSED!")
          PY

      - name: Upload Preprocessed Data
        uses: actions/upload-artifact@v4
        with:
          name: preprocessed-wine-data
          path: preprosessing/data/output/*
          retention-days: 30

      - name: Summary Report
        run: |
          echo "## Preprocessing Pipeline SUCCESS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Data berhasil di-preprocess dan divalidasi" >> $GITHUB_STEP_SUMMARY
          echo "- Artifact: \`preprocessed-wine-data\`" >> $GITHUB_STEP_SUMMARY
          echo "- Siap untuk training!" >> $GITHUB_STEP_SUMMARY
