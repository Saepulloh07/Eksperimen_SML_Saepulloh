name: Wine Quality Preprocessing Pipeline

on:
  push:
    branches: [main, develop]
    paths:
      - "preprosessing/**"
      - ".github/workflows/preprocessing-pipeline.yml"
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  preprocessing:
    name: Data Preprocessing
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: pip

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy scikit-learn joblib matplotlib seaborn python-dotenv

      - name: Verify Folder Exists
        run: |
          ls -la preprosessing/ || (echo "Folder preprosessing not found!" && exit 1)

      - name: Run Preprocessing Script
        working-directory: ./preprosessing
        run: |
          echo "Starting preprocessing..."
          python automation_Saepulloh.py
          echo "Preprocessing completed."

      - name: Verify Output Files
        working-directory: ./preprosessing/data/output
        run: |
          echo "Generated files:"
          ls -lh
          for f in X_train_scaled.npy X_test_scaled.npy y_train.npy y_test.npy scaler.pkl feature_names.pkl; do
            [ -f "$f" ] && echo "$f OK" || (echo "$f MISSING" && exit 1)
          done

      - name: Show Dataset Statistics
        working-directory: ./preprosessing
        run: |
          python - <<PY
          import numpy as np, pickle
          X_train = np.load('data/output/X_train_scaled.npy')
          y_train = np.load('data/output/y_train.npy')
          with open('data/output/feature_names.pkl', 'rb') as f:
              features = pickle.load(f)
          print(f"Samples: {X_train.shape[0]} train, {np.load('data/output/X_test_scaled.npy').shape[0]} test")
          print(f"Features: {len(features)}")
          print(f"Classes: {dict(zip(*np.unique(y_train, return_counts=True)))}")
          PY

      - name: Upload Preprocessed Data
        uses: actions/upload-artifact@v4
        with:
          name: preprocessed-wine-data
          path: preprosessing/data/output/
          retention-days: 30

      - name: Summary
        run: |
          echo "## Preprocessing Completed" >> $GITHUB_STEP_SUMMARY
          echo "- Data split and scaled" >> $GITHUB_STEP_SUMMARY
          echo "- Artifact: \`preprocessed-wine-data\`" >> $GITHUB_STEP_SUMMARY

  data-validation:
    name: Data Quality Checks
    runs-on: ubuntu-latest
    needs: preprocessing
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: preprocessed-wine-data
          path: ./data/

      - name: Validate Data
        run: |
          python - <<PY
          import numpy as np
          X_train = np.load('data/X_train_scaled.npy')
          if np.isnan(X_train).any():
              print("NaN detected!"); exit(1)
          mean, std = X_train.mean(), X_train.std()
          if not (-0.1 < mean < 0.1 and 0.9 < std < 1.1):
              print(f"Bad scaling: mean={mean:.4f}, std={std:.4f}"); exit(1)
          print("All data quality checks passed")
          PY
