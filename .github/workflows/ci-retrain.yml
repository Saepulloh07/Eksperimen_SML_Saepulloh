name: CI - Retrain & Build Docker Image

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  retrain-and-build-docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: "3.12"

      - name: Create Conda Environment
        shell: bash -l {0}
        run: |
          conda env create -f Workflow-CI-Saepulloh/MLProject/conda.yaml
          echo "heart-disease-env" >> $GITHUB_ENV

      - name: Install Extra Packages
        shell: bash -l {0}
        run: |
          conda activate heart-disease-env
          pip install --no-cache-dir mlflow[extras] python-dotenv dagshub jq

      - name: Run MLflow Project (Retraining)
        shell: bash -l {0}
        env:
          DAGSHUB_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
          DAGSHUB_REPO: ${{ secrets.DAGSHUB_REPO }}
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          conda activate heart-disease-env
          cd Workflow-CI-Saepulloh/MLProject

          # Cara resmi 2025 â€“ tanpa --no-conda
          python -c "import mlflow; mlflow.run('.')"

          # Ambil run ID terakhir
          LATEST_RUN_ID=$(mlflow runs list --experiment-name=Heart_Disease_Tuned_Models --max-results=1 --output-format=json | jq -r '.[0].info.run_id // empty')
          [ -z "$LATEST_RUN_ID" ] && LATEST_RUN_ID=$(mlflow runs list --experiment-name=Heart_Disease_Classification --max-results=1 --output-format=json | jq -r '.[0].info.run_id')
          echo "LATEST_RUN_ID=$LATEST_RUN_ID" >> $GITHUB_ENV

      - name: Build Docker Image
        shell: bash -l {0}
        run: |
          conda activate heart-disease-env
          cd Workflow-CI-Saepulloh/MLProject
          IMAGE="${{ secrets.DOCKER_USERNAME }}/heart-disease-model"

          mlflow models build-docker \
            --model-uri runs:/${{ env.LATEST_RUN_ID }}/model \
            --name $IMAGE \
            --enable-mlserver

          echo "IMAGE_NAME=$IMAGE:latest" >> $GITHUB_ENV

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Push Docker Images
        run: |
          docker tag ${{ env.IMAGE_NAME }} ${{ env.IMAGE_NAME }}:latest
          docker tag ${{ env.IMAGE_NAME }} ${{ env.IMAGE_NAME }}:v$(date +%Y%m%d-%H%M)
          docker push ${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.IMAGE_NAME }}:v$(date +%Y%m%d-%H%M)

      - name: Success
        run: |
          echo "SELESAI! Model retrained + Docker image terbaru sudah di-push"
          echo "https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/heart-disease-model"
