name: CI - Retrain & Build Docker Image

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"
  WORKING_DIR: "Workflow-CI-Saepulloh/MLProject"

jobs:
  retrain-and-build-docker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/conda.yaml') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy scikit-learn mlflow matplotlib seaborn python-dotenv dagshub

      - name: Setup MLflow Local Tracking Only
        run: |
          echo "MLFLOW_TRACKING_URI=file:./mlruns" >> $GITHUB_ENV
          echo "Using local MLflow tracking (no remote dependency during build)"

      - name: Check Data Files
        run: |
          cd ${{ env.WORKING_DIR }}
          if [ ! -f "data/preprocessing_objects.pkl" ]; then
            echo "ERROR: preprocessing_objects.pkl not found!"
            ls -la data/ || echo "data/ folder missing"
            exit 1
          fi
          echo "Data verified"

      - name: Run Model Training
        run: |
          cd ${{ env.WORKING_DIR }}
          python modelling.py --model_name all

      - name: Extract Best Model Info
        id: model_info
        run: |
          cd ${{ env.WORKING_DIR }}
          BEST_MODEL=$(ls data/best_model_*.pkl | head -1)
          MODEL_NAME=$(basename "$BEST_MODEL" | sed 's/best_model_//' | sed 's/\.pkl$//')
          echo "BEST_MODEL_FILE=$BEST_MODEL" >> $GITHUB_ENV
          echo "BEST_MODEL_NAME=$MODEL_NAME" >> $GITHUB_ENV
          echo "model_file=$(basename $BEST_MODEL)" >> $GITHUB_OUTPUT
          echo "model_name=$MODEL_NAME" >> $GITHUB_OUTPUT
          echo "Best model: $MODEL_NAME â†’ $BEST_MODEL"

      - name: Create Inference Server Script
        run: |
          cd ${{ env.WORKING_DIR }}
          cat > serve.py << 'EOF'
import pickle
import pandas as pd
from fastapi import FastAPI
from pydantic import BaseModel
import uvicorn
import os

# Load model
MODEL_PATH = os.getenv("MODEL_PATH", "best_model.pkl")
with open(MODEL_PATH, "rb") as f:
    model = pickle.load(f)

app = FastAPI(title="Heart Disease Prediction API")

class Features(BaseModel):
    age: int
    sex: int
    cp: int
    trestbps: int
    chol: int
    fbs: int
    restecg: int
    thalach: int
    exang: int
    oldpeak: float
    slope: int
    ca: int
    thal: int

@app.get("/ping")
async def ping():
    return {"message": "OK"}

@app.post("/predict")
async def predict(features: Features):
    df = pd.DataFrame([features.dict()])
    pred = model.predict(df)[0]
    prob = model.predict_proba(df)[0].max()
    return {
        "prediction": int(pred),
        "probability": float(prob),
        "model": "${{ env.BEST_MODEL_NAME }}"
    }

if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8080)
EOF
          echo "serve.py created"

      - name: Create Dockerfile
        run: |
          cd ${{ env.WORKING_DIR }}
          cat > Dockerfile << EOF
FROM python:3.12-slim

WORKDIR /app

# Install dependencies
RUN pip install --no-cache-dir fastapi uvicorn scikit-learn pandas pickle5

# Copy model and server
COPY ${{ steps.model_info.outputs.model_file }} /app/best_model.pkl
COPY serve.py /app/serve.py

EXPOSE 8080

ENV MODEL_PATH=/app/best_model.pkl

CMD ["uvicorn", "serve.py:app", "--host", "0.0.0.0", "--port", "8080"]
EOF
          echo "Dockerfile created with model: ${{ steps.model_info.outputs.model_file }}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        run: |
          cd ${{ env.WORKING_DIR }}
          IMAGE="${{ secrets.DOCKER_USERNAME }}/heart-disease-model"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          SHORT_RUN_ID=$(echo "${{ github.sha }}" | cut -c1-8)

          docker build -t $IMAGE:latest .
          docker tag $IMAGE:latest $IMAGE:v$TIMESTAMP
          docker tag $IMAGE:latest $IMAGE:$SHORT_RUN_ID

          docker push $IMAGE:latest
          docker push $IMAGE:v$TIMESTAMP
          docker push $IMAGE:$SHORT_RUN_ID

          echo "IMAGE_LATEST=$IMAGE:latest" >> $GITHUB_ENV
          echo "IMAGE_VERSIONED=$IMAGE:v$TIMESTAMP" >> $GITHUB_ENV
          echo "IMAGE_RUN=$IMAGE:$SHORT_RUN_ID" >> $GITHUB_ENV

      - name: Test Docker Image
        run: |
          docker run -d -p 5000:8080 --name test-container ${{ env.IMAGE_LATEST }}
          sleep 10
          curl -f http://localhost:5000/ping || (docker logs test-container && exit 1)
          echo "Docker image test passed"
          docker stop test-container && docker rm test-container

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: model-and-results
          path: |
            ${{ env.WORKING_DIR }}/data/best_model_*.pkl
            ${{ env.WORKING_DIR }}/csv_output/

      - name: Summary
        run: |
          echo "## CI/CD Success!" >> $GITHUB_STEP_SUMMARY
          echo "- **Best Model**: ${{ env.BEST_MODEL_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Images**:" >> $GITHUB_STEP_SUMMARY
          echo "  - \`${{ env.IMAGE_LATEST }}\`" >> $GITHUB_STEP_SUMMARY
          echo "  - \`${{ env.IMAGE_VERSIONED }}\`" >> $GITHUB_STEP_SUMMARY
          echo "  - \`${{ env.IMAGE_RUN }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker run -p 5000:8080 ${{ env.IMAGE_LATEST }}" >> $GITHUB_STEP_SUMMARY
          echo "curl -X POST http://localhost:5000/predict -H 'Content-Type: application/json' -d '{...}'" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY