name: CI - Retrain & Build Docker Image

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"
  WORKING_DIR: "Workflow-CI-Saepulloh/MLProject"

jobs:
  retrain-and-build-docker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/conda.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy scikit-learn mlflow matplotlib seaborn python-dotenv dagshub

      - name: Verify Installation
        run: |
          python --version
          pip list | grep -E "mlflow|pandas|scikit-learn"
          which mlflow

      - name: Setup DagsHub Credentials
        env:
          DAGSHUB_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
          DAGSHUB_REPO: ${{ secrets.DAGSHUB_REPO }}
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          # Configure DagsHub if credentials available
          if [ -n "$DAGSHUB_TOKEN" ] && [ -n "$DAGSHUB_USERNAME" ] && [ -n "$DAGSHUB_REPO" ]; then
            echo "Configuring DagsHub tracking..."
            export MLFLOW_TRACKING_URI="https://dagshub.com/${DAGSHUB_USERNAME}/${DAGSHUB_REPO}.mlflow"
            export MLFLOW_TRACKING_USERNAME="${DAGSHUB_USERNAME}"
            export MLFLOW_TRACKING_PASSWORD="${DAGSHUB_TOKEN}"
            echo "MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI}" >> $GITHUB_ENV
            echo "MLFLOW_TRACKING_USERNAME=${MLFLOW_TRACKING_USERNAME}" >> $GITHUB_ENV
            echo "MLFLOW_TRACKING_PASSWORD=${MLFLOW_TRACKING_PASSWORD}" >> $GITHUB_ENV
            echo "âœ“ DagsHub configured"
          else
            echo "Using local MLflow tracking"
          fi

      - name: Check Data Files
        run: |
          cd ${{ env.WORKING_DIR }}

          if [ ! -f "data/preprocessing_objects.pkl" ]; then
            echo "ERROR: preprocessing_objects.pkl not found!"
            echo "Available files in data/:"
            ls -la data/ 2>/dev/null || echo "data/ directory not found"
            exit 1
          fi

          echo "âœ“ Data files verified"
          ls -lh data/preprocessing_objects.pkl

      - name: Run Model Training
        run: |
          cd ${{ env.WORKING_DIR }}

          echo "Starting model training..."
          echo "Working directory: $(pwd)"

          # Run training directly with Python
          python modelling.py --model_name all

          echo "âœ“ Training completed successfully"

      - name: Get Latest Run ID
        id: get_run_id
        run: |
          cd ${{ env.WORKING_DIR }}

          # Get latest run ID from MLflow
          LATEST_RUN_ID=$(python -c "
          import mlflow
          import os

          mlflow.set_tracking_uri('file:./mlruns')
          client = mlflow.tracking.MlflowClient()

          # Get experiment
          experiment = client.get_experiment_by_name('Heart_Disease_Classification')
          if experiment is None:
              print('ERROR: Experiment not found')
              exit(1)

          # Get latest run
          runs = client.search_runs(
              experiment_ids=[experiment.experiment_id],
              order_by=['start_time DESC'],
              max_results=1
          )

          if runs:
              print(runs[0].info.run_id)
          else:
              print('ERROR: No runs found')
              exit(1)
          ")

          if [ -z "$LATEST_RUN_ID" ] || [ "$LATEST_RUN_ID" = "ERROR:"* ]; then
            echo "ERROR: Could not retrieve run ID"
            exit 1
          fi

          echo "LATEST_RUN_ID=$LATEST_RUN_ID" >> $GITHUB_ENV
          echo "run_id=$LATEST_RUN_ID" >> $GITHUB_OUTPUT
          echo "âœ“ Latest Run ID: $LATEST_RUN_ID"

      - name: Verify Model Artifact
        run: |
          cd ${{ env.WORKING_DIR }}

          echo "Checking artifacts for run: ${{ env.LATEST_RUN_ID }}"

          python -c "
          import mlflow

          mlflow.set_tracking_uri('file:./mlruns')
          client = mlflow.tracking.MlflowClient()

          try:
              artifacts = client.list_artifacts('${{ env.LATEST_RUN_ID }}')
              print('Available artifacts:')
              for artifact in artifacts:
                  print(f'  âœ“ {artifact.path}')
              
              # Check if best_model exists
              has_best_model = any('best_model' in a.path for a in artifacts)
              if not has_best_model:
                  print('WARNING: best_model artifact not found!')
                  exit(1)
              
              print('\nâœ“ Model artifacts verified')
          except Exception as e:
              print(f'ERROR: {e}')
              exit(1)
          "

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker Image with MLflow
        run: |
          cd ${{ env.WORKING_DIR }}

          echo "Building Docker image from MLflow model..."

          mlflow models build-docker \
            --model-uri "runs:/${{ env.LATEST_RUN_ID }}/best_model" \
            --name "${{ secrets.DOCKER_USERNAME }}/heart-disease-model" \
            --enable-mlserver

          echo "âœ“ Docker image built successfully"

      - name: Tag and Push Docker Images
        run: |
          IMAGE_BASE="${{ secrets.DOCKER_USERNAME }}/heart-disease-model"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          RUN_ID="${{ env.LATEST_RUN_ID }}"

          echo "Tagging and pushing images..."

          # Tag with multiple versions
          docker tag "${IMAGE_BASE}:latest" "${IMAGE_BASE}:latest"
          docker tag "${IMAGE_BASE}:latest" "${IMAGE_BASE}:v${TIMESTAMP}"
          docker tag "${IMAGE_BASE}:latest" "${IMAGE_BASE}:${RUN_ID}"

          # Push all tags
          docker push "${IMAGE_BASE}:latest"
          docker push "${IMAGE_BASE}:v${TIMESTAMP}"
          docker push "${IMAGE_BASE}:${RUN_ID}"

          # Save image info
          echo "IMAGE_LATEST=${IMAGE_BASE}:latest" >> $GITHUB_ENV
          echo "IMAGE_VERSIONED=${IMAGE_BASE}:v${TIMESTAMP}" >> $GITHUB_ENV
          echo "IMAGE_RUN=${IMAGE_BASE}:${RUN_ID}" >> $GITHUB_ENV

          echo "âœ“ Docker images pushed successfully"

      - name: Create Summary
        run: |
          echo "## ğŸ‰ CI/CD Pipeline Completed Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Training Results" >> $GITHUB_STEP_SUMMARY
          echo "- MLflow Run ID: \`${{ env.LATEST_RUN_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Experiment: Heart_Disease_Classification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ³ Docker Images" >> $GITHUB_STEP_SUMMARY
          echo "The following images have been pushed to Docker Hub:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_LATEST }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_VERSIONED }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_RUN }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ Quick Start" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.IMAGE_LATEST }}" >> $GITHUB_STEP_SUMMARY
          echo "docker run -p 5000:8080 ${{ env.IMAGE_LATEST }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Docker Hub Repository](https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/heart-disease-model)" >> $GITHUB_STEP_SUMMARY

      - name: Final Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          CI/CD PIPELINE COMPLETED SUCCESSFULLY!            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ“ Model retrained successfully"
          echo "âœ“ MLflow Run ID: ${{ env.LATEST_RUN_ID }}"
          echo "âœ“ Docker images built and pushed"
          echo ""
          echo "ğŸ“¦ Docker Images:"
          echo "  - ${{ env.IMAGE_LATEST }}"
          echo "  - ${{ env.IMAGE_VERSIONED }}"
          echo "  - ${{ env.IMAGE_RUN }}"
          echo ""
          echo "ğŸ”— Docker Hub: https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/heart-disease-model"
