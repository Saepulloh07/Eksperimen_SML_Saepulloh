name: CI - Retrain & Deploy Docker Image

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  retrain-and-deploy:
    runs-on: ubuntu-latest

    env:
      MLFLOW_TRACKING_URI: https://dagshub.com/$$ {{ secrets.DAGSHUB_USERNAME }}/ $${{ secrets.DAGSHUB_REPO }}.mlflow
      MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
      MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}

    steps:
      steps:
        - name: Checkout Code
          uses: actions/checkout@v4

        - name: Setup Miniconda
          uses: conda-incubator/setup-miniconda@v3
          with:
            python-version: "3.12.7"
            activate-environment: heart-disease-env

        - name: Install Environment & MLflow
          shell: bash -l {0}
          run: |
            conda env create -f Workflow-CI-Saepulloh/MLProject/conda.yaml
            conda activate heart-disease-env
            pip install --no-cache-dir mlflow[extras] dagshub

        - name: Retrain Model (All Models) + Log to DagsHub
          shell: bash -l {0}
          run: |
            conda activate heart-disease-env
            cd Workflow-CI-Saepulloh/MLProject

            # Pastikan tracking URI aktif
            echo "Tracking URI: $MLFLOW_TRACKING_URI"

            # Jalankan semua model
            mlflow run . -P model_name=all

            echo "Retraining selesai! Model sudah di-log ke DagsHub"

        - name: Get Best Model Run ID (Otomatis & Aman)
          shell: bash -l {0}
          run: |
            conda activate heart-disease-env
            cd Workflow-CI-Saepulloh/MLProject

            python - <<'PY'
            import mlflow
            from mlflow.tracking import MlflowClient
            import os

            client = MlflowClient()
            exp = client.get_experiment_by_name("Heart_Disease_Classification")
            if not exp:
                raise Exception("Experiment tidak ditemukan! Pastikan sudah ada run sebelumnya atau nama benar.")

            # Cari run dengan akurasi terbaik
            runs = client.search_runs(
                experiment_ids=[exp.experiment_id],
                filter_string="metrics.best_accuracy > 0",
                order_by=["metrics.best_accuracy DESC"],
                max_results=1
            )

            if not runs:
                raise Exception("Tidak ada run dengan metric best_accuracy!")

            run_id = runs[0].info.run_id
            acc = runs[0].data.metrics["best_accuracy"]

            print(f"Best Run ID : {run_id}")
            print(f"Accuracy    : {acc:.4f}")

            # Simpan ke GitHub Env
            with open(os.environ["GITHUB_ENV"], "a") as f:
                f.write(f"BEST_RUN_ID={run_id}\n")
                f.write(f"BEST_ACCURACY={acc:.4f}\n")
            PY

        - name: Build & Push Docker Image
          shell: bash -l {0}
          env:
            DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
            DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          run: |
            conda activate heart-disease-env
            cd Workflow-CI-Saepulloh/MLProject

            IMAGE="heart-disease-model"

            mlflow models build-docker \
              --model-uri runs:/${{ env.BEST_RUN_ID }}/best_model \
              --name ${{ secrets.DOCKER_USERNAME }}/$IMAGE \
              --enable-mlserver

            # Tag
            docker tag ${{ secrets.DOCKER_USERNAME }}/$IMAGE:latest \
                       ${{ secrets.DOCKER_USERNAME }}/$$ IMAGE:v $$(date +%Y%m%d-%H%M%S)

            # Login & Push
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
            docker push ${{ secrets.DOCKER_USERNAME }}/$IMAGE:latest
            docker push ${{ secrets.DOCKER_USERNAME }}/$$ IMAGE:v $$(date +%Y%m%d-%H%M%S)

            echo "IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/$IMAGE:latest" >> $GITHUB_ENV

        - name: Success â€“ Model Deployed!
          run: |
            echo ""
            echo "DEPLOY BERHASIL!"
            echo "Model Terbaik : ${{ env.BEST_ACCURACY }} (Run ID       : ${{ env.BEST_RUN_ID }}"
            echo "Docker Image  : ${{ env.IMAGE_NAME }}"
            echo ""
            echo "MLflow UI     : https://dagshub.com/$$ {{ secrets.DAGSHUB_USERNAME }}/ $${{ secrets.DAGSHUB_REPO }}/experiments/"
            echo "Docker Hub   : https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/heart-disease-model"
