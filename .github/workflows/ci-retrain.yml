name: CI - Retrain & Build Docker Image

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12.7"
  CONDA_ENV_NAME: "heart-disease-env"

jobs:
  retrain-and-build-docker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: ${{ env.PYTHON_VERSION }}
          miniconda-version: "latest"
          activate-environment: ${{ env.CONDA_ENV_NAME }}

      - name: Verify Conda Installation
        shell: bash -l {0}
        run: |
          conda --version
          conda info
          which python

      - name: Create Conda Environment
        shell: bash -l {0}
        run: |
          cd Workflow-CI-Saepulloh/MLProject
          conda env create -f conda.yaml --force
          conda env list

      - name: Install Additional Dependencies
        shell: bash -l {0}
        run: |
          conda activate ${{ env.CONDA_ENV_NAME }}
          pip install --no-cache-dir jq

      - name: Verify Environment
        shell: bash -l {0}
        run: |
          conda activate ${{ env.CONDA_ENV_NAME }}
          python --version
          pip list
          which mlflow

      - name: Setup DagsHub Credentials
        shell: bash -l {0}
        env:
          DAGSHUB_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
          DAGSHUB_REPO: ${{ secrets.DAGSHUB_REPO }}
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          conda activate ${{ env.CONDA_ENV_NAME }}

          # Configure DagsHub if credentials available
          if [ -n "$DAGSHUB_TOKEN" ] && [ -n "$DAGSHUB_USERNAME" ] && [ -n "$DAGSHUB_REPO" ]; then
            echo "Configuring DagsHub tracking..."
            export MLFLOW_TRACKING_URI="https://dagshub.com/${DAGSHUB_USERNAME}/${DAGSHUB_REPO}.mlflow"
            export MLFLOW_TRACKING_USERNAME="${DAGSHUB_USERNAME}"
            export MLFLOW_TRACKING_PASSWORD="${DAGSHUB_TOKEN}"
            echo "MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI}" >> $GITHUB_ENV
            echo "MLFLOW_TRACKING_USERNAME=${MLFLOW_TRACKING_USERNAME}" >> $GITHUB_ENV
            echo "MLFLOW_TRACKING_PASSWORD=${MLFLOW_TRACKING_PASSWORD}" >> $GITHUB_ENV
          else
            echo "Using local MLflow tracking"
          fi

      - name: Check Data Files
        shell: bash -l {0}
        run: |
          cd Workflow-CI-Saepulloh/MLProject

          if [ ! -f "data/preprocessing_objects.pkl" ]; then
            echo "ERROR: preprocessing_objects.pkl not found!"
            echo "Available files in data/:"
            ls -la data/ || echo "data/ directory not found"
            exit 1
          fi

          echo "✓ Data files verified"

      - name: Run MLflow Project (Retraining)
        shell: bash -l {0}
        run: |
          conda activate ${{ env.CONDA_ENV_NAME }}
          cd Workflow-CI-Saepulloh/MLProject

          echo "Starting model training..."
          echo "Working directory: $(pwd)"

          # Run MLflow project
          mlflow run . \
            --env-manager=conda \
            --experiment-name=Heart_Disease_Classification

          echo "✓ Training completed successfully"

      - name: Get Latest Run ID
        shell: bash -l {0}
        run: |
          conda activate ${{ env.CONDA_ENV_NAME }}
          cd Workflow-CI-Saepulloh/MLProject

          # Get latest run ID from MLflow
          LATEST_RUN_ID=$(mlflow runs list \
            --experiment-name=Heart_Disease_Classification \
            --max-results=1 \
            --output-format=json \
            | python -c "import sys, json; data = json.load(sys.stdin); print(data[0]['info']['run_id'] if data else '')")

          if [ -z "$LATEST_RUN_ID" ]; then
            echo "ERROR: Could not retrieve run ID"
            mlflow experiments list
            exit 1
          fi

          echo "LATEST_RUN_ID=$LATEST_RUN_ID" >> $GITHUB_ENV
          echo "✓ Latest Run ID: $LATEST_RUN_ID"

      - name: Verify Model Artifact
        shell: bash -l {0}
        run: |
          conda activate ${{ env.CONDA_ENV_NAME }}
          cd Workflow-CI-Saepulloh/MLProject

          # Check if model artifact exists
          MODEL_URI="runs:/${{ env.LATEST_RUN_ID }}/best_model"

          echo "Checking model at: $MODEL_URI"

          # List artifacts for the run
          python -c "
          import mlflow
          client = mlflow.tracking.MlflowClient()
          artifacts = client.list_artifacts('${{ env.LATEST_RUN_ID }}')
          print('Available artifacts:')
          for artifact in artifacts:
              print(f'  - {artifact.path}')
          "

      - name: Build Docker Image
        shell: bash -l {0}
        run: |
          conda activate ${{ env.CONDA_ENV_NAME }}
          cd Workflow-CI-Saepulloh/MLProject

          echo "Building Docker image..."

          mlflow models build-docker \
            --model-uri "runs:/${{ env.LATEST_RUN_ID }}/best_model" \
            --name "${{ secrets.DOCKER_USERNAME }}/heart-disease-model" \
            --enable-mlserver

          echo "IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/heart-disease-model:latest" >> $GITHUB_ENV
          echo "✓ Docker image built successfully"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Tag and Push Docker Images
        run: |
          IMAGE_BASE="${{ secrets.DOCKER_USERNAME }}/heart-disease-model"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)

          # Tag images
          docker tag "${IMAGE_BASE}:latest" "${IMAGE_BASE}:latest"
          docker tag "${IMAGE_BASE}:latest" "${IMAGE_BASE}:v${TIMESTAMP}"
          docker tag "${IMAGE_BASE}:latest" "${IMAGE_BASE}:run-${{ env.LATEST_RUN_ID }}"

          # Push all tags
          docker push "${IMAGE_BASE}:latest"
          docker push "${IMAGE_BASE}:v${TIMESTAMP}"
          docker push "${IMAGE_BASE}:run-${{ env.LATEST_RUN_ID }}"

          echo "✓ Docker images pushed successfully"
          echo "  - ${IMAGE_BASE}:latest"
          echo "  - ${IMAGE_BASE}:v${TIMESTAMP}"
          echo "  - ${IMAGE_BASE}:run-${{ env.LATEST_RUN_ID }}"

      - name: Summary
        run: |
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║          CI/CD PIPELINE COMPLETED SUCCESSFULLY!            ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          echo ""
          echo "✓ Model retrained successfully"
          echo "✓ MLflow Run ID: ${{ env.LATEST_RUN_ID }}"
          echo "✓ Docker images built and pushed"
          echo ""
          echo "Docker Hub: https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/heart-disease-model"
          echo ""
          echo "To pull the image:"
          echo "  docker pull ${{ secrets.DOCKER_USERNAME }}/heart-disease-model:latest"
