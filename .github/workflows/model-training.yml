name: Model Training Pipeline

on:
  workflow_run:
    workflows: ["Wine Quality Preprocessing Pipeline"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      model_type:
        description: "Training type"
        required: true
        default: "baseline"
        type: choice
        options:
          - baseline
          - tuned

env:
  DAGSHUB_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
  DAGSHUB_REPO: ${{ secrets.DAGSHUB_REPO }}
  DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}

jobs:
  train-baseline:
    name: Train Baseline Model
    runs-on: ubuntu-latest
    if: github.event.inputs.model_type == 'baseline' || github.event.inputs.model_type == ''

    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: "pip"

      - name: ğŸ“¦ Install Dependencies
        run: |
          cd Membangun_model
          pip install -r requirements.txt

      - name: ğŸ‹ï¸ Train Baseline Model
        working-directory: ./Membangun_model
        run: |
          echo "ğŸš€ Starting baseline model training..."
          python modelling.py
          echo "âœ… Training completed!"

      - name: ğŸ“¤ Upload Model Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: baseline-model-artifacts
          path: |
            Membangun_model/artifacts/
            Membangun_model/wine_quality_model.pkl
          retention-days: 30

      - name: ğŸ“Š Upload to GitHub Release (if tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            Membangun_model/wine_quality_model.pkl
            Membangun_model/artifacts/*

  train-tuned:
    name: Train Tuned Model
    runs-on: ubuntu-latest
    if: github.event.inputs.model_type == 'tuned'

    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: "pip"

      - name: ğŸ“¦ Install Dependencies
        run: |
          cd Membangun_model
          pip install -r requirements.txt

      - name: ğŸ¯ Train Tuned Model
        working-directory: ./Membangun_model
        run: |
          echo "ğŸš€ Starting hyperparameter tuning..."
          python modelling_tuning.py
          echo "âœ… Tuning completed!"

      - name: ğŸ“¤ Upload Model Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: tuned-model-artifacts
          path: |
            Membangun_model/artifacts/
            Membangun_model/best_model_tuned.pkl
          retention-days: 30

  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [train-baseline]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ“¥ Download Model Artifacts
        uses: actions/download-artifact@v3
        with:
          name: baseline-model-artifacts
          path: ./Membangun_model/

      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ³ Build and Push Docker Image
        run: |
          cd Membangun_model
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/wine-quality-model:latest .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/wine-quality-model:latest

          # Tag with commit SHA
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/wine-quality-model:latest \
                     ${{ secrets.DOCKERHUB_USERNAME }}/wine-quality-model:${{ github.sha }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/wine-quality-model:${{ github.sha }}
